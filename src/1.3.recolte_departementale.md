---
title: Récolte de bois départementale
toc: false
sql:
  recolte_departements_historique: ./data/recolte_departements_historique.csv
---

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Début du code pour la présentation de la page
------------------------------------------------------------------------------------------------------------------------ -->

<link rel="stylesheet" href="./style.css">

<div style = "background-color: #f0f4f8;border: 2px solid #d1d9e6;border-radius: 10px;text-align: right;padding: 23px;font-family: Marianne, sans-serif;font-size: 20px;font-weight: bold;color: #333;text-decoration: none;transition: transform 0.2s ease, box-shadow 0.2s ease;width: 80%;">
  <h2> Récolte de bois départementale </h2>
</div>

<h3><br>Choix des paramètres : </h3>

```js
/*Affichage des 3 listes de paramètres dynamiques*/ 
const choix_liste_departements1 = view(Inputs.select(noms_departements, { label: "Choississez un département :"}));
const choix_liste_essences1 = view(Inputs.select(noms_essences, { label: "Choisissez une essence :"}));
const choix_liste_annee1 = view(Inputs.select(annees, { label: "Choisissez une année :", value: annees.sort().reverse()[0]}));
```

---

<h3>Résumé</h3><br>

<h4>En ${choix_liste_annee1}, ${chiffre_cle_volume_annee.toFixed(0)} milliers de m3 ronds sur écorce de "${choix_liste_essences1}" ont été récoltés dans le département "${choix_liste_departements1}".</h4>

---

<h3>Répartition de la récolte départementale en ${choix_liste_annee1} dans le département "${choix_liste_departements1}" : </h3>

<div style="width: 2000px; height: 530px; overflow: hidden; border: 0px solid #999999;">
<br>
  ${treemap_recolte_dep}
  <br>
  <div style="width: 5000px; height: 45px; overflow: hidden; border: 0px solid #999999;font-size: 14px;margin-bottom: 0 ">
  <i>Graphique 1 : Répartition de la récolte départementale en ${choix_liste_annee1} dans le département "${choix_liste_departements1}".<br> Source : Enquête EXF-SRI</i>
  </div>
</div>

---

<h3>Evolution de la récolte départementale historique de "${choix_liste_essences1}" : </h3>

<br>(Optionnel) Vous pouvez choisir un second département à comparer :

```js
/*Affichage des listes de paramètres dynamiques*/ 
const choix_liste_departements2 = view(Inputs.select(noms_departements));
```

<div style="width: 2000px; height: 600px; overflow: hidden; border: 0px solid #999999;">
  ${graph_recolte_dep_hist}
  <div style="width: 5000px; height: 45px; overflow: hidden; border: 0px solid #999999;font-size: 14px;margin-bottom: 0 ">
  <i>Graphique 2 : Evolution de la récolte départementale historique de  "${choix_liste_essences1}".<br> Source : Enquête EXF-SRI</i>
  </div>
</div>

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Fin du code pour la présentation de la page
------------------------------------------------------------------------------------------------------------------------ -->

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Début du code pour réaliser les graphiques
------------------------------------------------------------------------------------------------------------------------ -->

```js
import { select, table } from "@observablehq/inputs";
import {createOptionsEChartsFromData} from "./components/graphHisto.js";
import {Treemap} from "./data/fonctions.js"
```

```sql id=liste_departements
/*Requête pour obtenir la liste des départements*/ 
SELECT DISTINCT Département as departements
FROM recolte_departements_historique
```

```sql id=liste_essences
/*Requête pour obtenir la liste des essences*/ 
SELECT DISTINCT Récolte as essences 
FROM recolte_departements_historique
```

```sql id=borne_annees
/*Requête pour obtenir la liste des années*/ 
SELECT 
  MIN(CAST(column_name AS INTEGER)) AS annee_min,
  MAX(CAST(column_name AS INTEGER)) AS annee_max
FROM (
  SELECT column_name
  FROM information_schema.columns
  WHERE table_name='recolte_departements_historique'
  AND column_name LIKE '____' -- 4 caractères
)
```

```js
/*Création de la liste des années à partir des bornes obtenues dans la requête*/ 
const { annee_min, annee_max } = borne_annees.toArray()[0];
const annees = Array.from(
  { length: annee_max - annee_min + 1 }, 
  (_, i) => (annee_min + i).toString()
);
```

```js
/*Mise en forme*/ 
const tab_departements = liste_departements.toArray();
const tab_essences = liste_essences.toArray();
```

```js
/*Mise en forme*/ 
const noms_departements = tab_departements.map(d => d.departements);
const noms_essences = tab_essences.map(d => d.essences);
```

<!-- ------------------------------
Chargement des données CSV
-------------------------------- -->

```js
const fichier_recolte_init = await FileAttachment("./data/recolte_departements_historique.csv").dsv({delimiter: ";", array: true})
const colonnes_fichier_recolte_init = fichier_recolte_init[0];
const lignes_fichier_recolte_init = fichier_recolte_init.slice(1);

const data_recolte = lignes_fichier_recolte_init.map(lignes_fichier_recolte_init => {
  const obj = {};
  colonnes_fichier_recolte_init.forEach((colonnes_fichier_recolte_init, index) => {
    obj[colonnes_fichier_recolte_init] = lignes_fichier_recolte_init[index];
  });
  return obj;
});
```

<!-- -------------------------------------------------------------------------------------------------------------------- -->
<!-- ------------------------------
Chiffre clé du résumé
-------------------------------- -->

```sql id=data_chiffre_cle_recolte
SELECT * 
FROM recolte_departements_historique 
WHERE Département=${choix_liste_departements1} 
AND Récolte=${choix_liste_essences1}
```

```js
const data_chiffre_cle_recolte_filtree = data_chiffre_cle_recolte.toArray();
const row_data_chiffre_cle_recolte_filtree = data_chiffre_cle_recolte_filtree[0];

const data_chiffre_cle_recolte_filtree_final = data_evol_recolte_dep1_filtree.flatMap(row_data_chiffre_cle_recolte_filtree => {
  const years1 = Object.keys(row_data_chiffre_cle_recolte_filtree).filter(d => /^\d{4}$/.test(d));
  return years1.map(y => ({
    Departement: row_data_chiffre_cle_recolte_filtree.Département,
    Annee: +y,
    Volume: parseFloat(row_data_chiffre_cle_recolte_filtree[y].replace(",", ".")),
    Recolte: row_data_chiffre_cle_recolte_filtree.Récolte
  }));
});

const chiffre_cle_volume_annee = data_chiffre_cle_recolte_filtree_final.find(item => item.Annee === Number(choix_liste_annee1))?.Volume;
```

<!-- -------------------------------------------------------------------------------------------------------------------- -->
<!-- ------------------------------
Treemap récolte départementale
-------------------------------- -->

```js
// Filtrage de l'année et du département pour le treemap départemental
const data_treemap_recolte_dep = data_recolte.map(lignes_fichier_recolte_init => ({
    Département: lignes_fichier_recolte_init["Département"],
    Récolte: lignes_fichier_recolte_init["Récolte"],
    Valeur: lignes_fichier_recolte_init[choix_liste_annee1]
  }));

const data_treemap_recolte_dep_2 = data_treemap_recolte_dep.filter(lignes_fichier_recolte_init => lignes_fichier_recolte_init.Département === choix_liste_departements1);

const data_treemap_recolte_dep_3 = data_treemap_recolte_dep_2.map(item => ({
  ...item,
  Récolte_AGG: item.Récolte.split(" - ")[0].trim(),
  Valeur: Number(item.Valeur.replace(",", "."))
}));
```

```js
const data_treemap_recolte_dep_4 = data_treemap_recolte_dep_3.filter(row => {
  const recolte = row.Récolte.trim();
  return recolte !== "RBC - Récolte de bois commercialisé" && 
         recolte !== "RBC - dont bois certifié*" &&
         recolte !== "BO - Bois d’œuvre" &&
         recolte !== "BO - dont grumes certifiées*" &&
         recolte !== "BO - Feuillus" &&
         recolte !== "BO - Chêne" &&
         recolte !== "BO - Hêtre" &&
         recolte !== "BO - Peuplier" &&
         recolte !== "BO - Conifères" &&
         recolte !== "BO - Pin maritime" &&
         recolte !== "BI - Bois d'industrie" &&
         recolte !== "BT - dont bois de trituration certifié*" &&
         recolte !== "BI - Autres bois d'industrie" &&
         recolte !== "ABI - dont bois d'industrie certifié*" &&
         recolte !== "BE - Bois énergie" &&
         recolte !== "BE - dont bois énergie certifié*";
});
```

```js
const AGG_LABELS = {
  BO: "Bois d'œuvre",
  BI: "Bois d'industrie",
  BE: "Bois énergie"
};

const AGG_COLORS = {
  BO: "#f4a261",
  BI: "#6baed6",
  BE: "#74c69d"
};
```

```js
function buildHierarchy(data) {
  const root = {
    name: "Total",
    children: []
  };

  const groups = d3.group(data, d => d.Récolte_AGG);

  for (const [agg, rows] of groups) {
    if (!AGG_LABELS[agg]) continue;

    const children = rows
      .filter(d => d.Valeur > 0 && d.Récolte.trim().startsWith(agg))
      .filter(d => !d.Récolte.includes("dont")) // optionnel selon votre règle
      .map(d => ({
        name: d.Récolte.replace(/^[-\s]+/, "").trim(),
        value: d.Valeur
      }));

    root.children.push({
      name: AGG_LABELS[agg],
      agg,
      children
    });
  }

  return root;
}
```

```js
{
const width = 1000;
const height = 500;

const dataHierarchy = buildHierarchy(data_treemap_recolte_dep_3); 

const root = d3.hierarchy(dataHierarchy)
  .sum(d => d.value)
  .sort((a, b) => b.value - a.value);

d3.treemap()
  .size([width, height])
  .paddingInner(3)
  .paddingTop(d => d.depth === 1 ? 25 : 5)
  (root);

const svg = d3.create("svg")
  .attr("width", width)
  .attr("height", height);

const nodes = svg.selectAll("g")
  .data(root.leaves())
  .enter()
  .append("g")
  .attr("transform", d => `translate(${d.x0},${d.y0})`);

nodes.append("rect")
  .attr("width", d => d.x1 - d.x0)
  .attr("height", d => d.y1 - d.y0)
  .attr("fill", d => AGG_COLORS[d.parent.data.agg])
  .attr("stroke", "#fff");

nodes.append("text")
  .attr("x", 6)
  .attr("y", 16)
  .attr("font-size", "12px")
  .attr("fill", "#000")
  .text(d => d.data.name);

nodes.append("text")
  .attr("x", 6)
  .attr("y", 32)
  .attr("font-size", "11px")
  .attr("fill", "#333")
  .text(d => d.value.toLocaleString("fr-FR"));

return svg.node();
}
```

```js
const treemap_recolte_dep = Treemap(data_treemap_recolte_dep_4, {
  path: (d) => d.Récolte_AGG + d.Récolte ,
  label: (d) => d.Récolte,
  group: (d) => d.Récolte_AGG,
  value: (d) => d?.Valeur,
  tile: d3.treemapSquarify,
  fontsize : 200
})
```

<!-- -------------------------------------------------------------------------------------------------------------------- -->
<!-- ---------------------------------------
Graphique évolution récolte départementale
---------------------------------------- -->

```sql id=data_evol_recolte_dep1
SELECT * 
FROM recolte_departements_historique 
WHERE Département=${choix_liste_departements1} 
AND Récolte=${choix_liste_essences1}
```

```sql id=data_evol_recolte_dep2
SELECT * 
FROM recolte_departements_historique 
WHERE Département=${choix_liste_departements2} 
AND Récolte=${choix_liste_essences1}
```

```js
const data_evol_recolte_dep1_filtree = data_evol_recolte_dep1.toArray();
const data_evol_recolte_dep2_filtree = data_evol_recolte_dep2.toArray();
```

```js
// On récupère la première ligne
const row_data_evol_recolte_dep1_filtree = data_evol_recolte_dep1_filtree[0];
const row_data_evol_recolte_dep2_filtree = data_evol_recolte_dep2_filtree[0];
```

```js
// On crée un tableau "long" {Departement, Annee, Volume}
const data_evol_recolte_dep1_filtree_final = data_evol_recolte_dep1_filtree.flatMap(row_data_evol_recolte_dep1_filtree => {
  const years1 = Object.keys(row_data_evol_recolte_dep1_filtree).filter(d => /^\d{4}$/.test(d));
  return years1.map(y => ({
    Departement: row_data_evol_recolte_dep1_filtree.Département,
    Annee: +y,
    Volume: parseFloat(row_data_evol_recolte_dep1_filtree[y].replace(",", ".")),
    Recolte: row_data_evol_recolte_dep1_filtree.Récolte
  }));
});

const data_evol_recolte_dep2_filtree_final = data_evol_recolte_dep2_filtree.flatMap(row_data_evol_recolte_dep2_filtree => {
  const years2 = Object.keys(row_data_evol_recolte_dep2_filtree).filter(d => /^\d{4}$/.test(d));
  return years2.map(y => ({
    Departement: row_data_evol_recolte_dep2_filtree.Département,
    Annee: +y,
    Volume: parseFloat(row_data_evol_recolte_dep2_filtree[y].replace(",", ".")),
    Recolte: row_data_evol_recolte_dep2_filtree.Récolte
  }));
});
```

```js
const maxVolume_data_evol_recolte_dep1_filtree = Math.max(...data_evol_recolte_dep1_filtree_final.map(d => d.Volume));
const maxVolume_data_evol_recolte_dep2_filtree = Math.max(...data_evol_recolte_dep2_filtree_final.map(d => d.Volume));
const maxVolume = Math.max(maxVolume_data_evol_recolte_dep1_filtree, maxVolume_data_evol_recolte_dep2_filtree);
```

```js
const graph_recolte_dep_hist = Plot.plot({
  width: 800,
  height: 400,
  x: {
    label: "Année",
    tickFormat: d => d.toString(), // texte pour l'axe X
  },
  y: {
    label: "Volume (en milliers de m3 ronds sur écorce)",
    domain: [0, maxVolume * 1.1]   // axe Y à partir de 0
  },
  color: {legend: true}, // légende pour différencier les départements
  marks: [
    // première courbe
    Plot.line(data_evol_recolte_dep1_filtree_final, {x: "Annee", y: "Volume", stroke: "Departement"}),
    Plot.dot(data_evol_recolte_dep1_filtree_final, {x: "Annee", y: "Volume", fill: "Departement",
                     title: d => `${d.Departement}\n${d.Annee}: ${d.Volume.toFixed(0)} milliers de m3 ronds sur écorce de ${d.Recolte}`}),
    
    // deuxième courbe
    Plot.line(data_evol_recolte_dep2_filtree_final, {x: "Annee", y: "Volume", stroke: "Departement"}),
    Plot.dot(data_evol_recolte_dep2_filtree_final, {x: "Annee", y: "Volume", fill: "Departement",
                     title: d => `${d.Departement}\n${d.Annee}: ${d.Volume.toFixed(0)} milliers de m3 ronds sur écorce de ${d.Recolte}`})
  ]
})
```
