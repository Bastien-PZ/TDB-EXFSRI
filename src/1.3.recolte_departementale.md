---
title: Récolte de bois départementale
toc: false
sql:
  recolte_departements_historique: ./data/recolte_departements_historique.csv
---

To do : Treemap de toutes les essences avec filtre par département et par année
To do : Cartes pour afficher des indicateurs clés (ou une phrase avec paramètres intégrés). 

<h1> Récolte de bois départementale </h1>









```js
import { select, table } from "@observablehq/inputs";
import {createOptionsEChartsFromData} from "./components/graphHisto.js";
import * as Plot from "npm:@observablehq/plot";
```


<!-- ------------------------------
Requêtes SQL pour listes dynamiques
-------------------------------- -->


```sql id=liste_departements
/*Requête pour obtenir la liste des départements*/ 
SELECT DISTINCT Département as departements
FROM recolte_departements_historique
```

```sql id=liste_essences
/*Requête pour obtenir la liste des essences*/ 
SELECT DISTINCT Récolte as essences 
FROM recolte_departements_historique
```

```sql id=borne_annees
/*Requête pour obtenir la liste des années*/ 
SELECT 
  MIN(CAST(column_name AS INTEGER)) AS annee_min,
  MAX(CAST(column_name AS INTEGER)) AS annee_max
FROM (
  SELECT column_name
  FROM information_schema.columns
  WHERE table_name='recolte_departements_historique'
  AND column_name LIKE '____' -- 4 caractères
)
```

```js
/*Création de la liste des années à partir des bornes obtenues dans la requête*/ 
const { annee_min, annee_max } = borne_annees.toArray()[0];
const annees = Array.from(
  { length: annee_max - annee_min + 1 }, 
  (_, i) => (annee_min + i).toString()
);
```

```js
/*Mise en forme*/ 
const tab_departements = liste_departements.toArray();
const tab_essences = liste_essences.toArray();

```

```js
/*Mise en forme*/ 
const noms_departements = tab_departements.map(d => d.departements);
const noms_essences = tab_essences.map(d => d.essences);

```

```js
/*Affichage des 3 listes de paramètres dynamiques*/ 
const choix_liste_departements1 = view(Inputs.select(noms_departements, { label: "Choississez un département :"}));
const choix_liste_essences1 = view(Inputs.select(noms_essences, { label: "Choisissez une essence :"}));
```

(Optionnel) Vous pouvez choisir un second département à comparer 

```js
/*Affichage des listes de paramètres dynamiques*/ 
const choix_liste_departements2 = view(Inputs.select(noms_departements));
```

```sql id=test1
SELECT * 
FROM recolte_departements_historique 
WHERE Département=${choix_liste_departements1} 
AND Récolte=${choix_liste_essences1}
```

```js
const table_filtree1 = test1.toArray();
```

```sql id=test2
SELECT * 
FROM recolte_departements_historique 
WHERE Département=${choix_liste_departements2} 
AND Récolte=${choix_liste_essences1}
```

```sql id=test3
SELECT * 
FROM recolte_departements_historique 
WHERE Département='France métropolitaine'
AND Récolte=${choix_liste_essences1}
```

```js
const table_filtree2 = test2.toArray();
```

```js
const table_filtree3 = test3.toArray();
```

```js
// On récupère la première ligne
const row1 = table_filtree1[0];
```

```js
// On récupère la première ligne
const row2 = table_filtree2[0];
```

```js
// On récupère la première ligne
const row3 = table_filtree3[0];
```



```js
// On extrait les années (toutes les clés numériques)
const years1 = Object.keys(row1).filter(d => /^\d{4}$/.test(d));

// On crée un tableau d’objets {year, value}
const data1 = years1.map(y => ({
  year: +y,
  value: +row1[y].replace(",", ".")   // conversion en nombre
}));
```

```js
// On extrait les années (toutes les clés numériques)
const years2 = Object.keys(row2).filter(d => /^\d{4}$/.test(d));

// On crée un tableau d’objets {year, value}
const data2 = years2.map(y => ({
  year: +y,
  value: +row2[y].replace(",", ".")   // conversion en nombre
}));
```

```js
// On extrait les années (toutes les clés numériques)
const years3 = Object.keys(row3).filter(d => /^\d{4}$/.test(d));

// On crée un tableau d’objets {year, value}
const data3 = years3.map(y => ({
  year: +y,
  value: +row3[y].replace(",", ".")   // conversion en nombre
}));
```


```js
// On crée un tableau "long" {Departement, Annee, Volume}
const data_long1 = table_filtree1.flatMap(row1 => {
  const years1 = Object.keys(row1).filter(d => /^\d{4}$/.test(d));
  return years1.map(y => ({
    Departement: row1.Département,
    Annee: +y,
    Volume: parseFloat(row1[y].replace(",", "."))
  }));
});

data_long1
```

```js
// On crée un tableau "long" {Departement, Annee, Volume}
const data_long2 = table_filtree2.flatMap(row2 => {
  const years2 = Object.keys(row2).filter(d => /^\d{4}$/.test(d));
  return years2.map(y => ({
    Departement: row2.Département,
    Annee: +y,
    Volume: parseFloat(row2[y].replace(",", "."))
  }));
});

data_long2
```

```js
// On crée un tableau "long" {Departement, Annee, Volume}
const data_long3 = table_filtree3.flatMap(row3 => {
  const years3 = Object.keys(row3).filter(d => /^\d{4}$/.test(d));
  return years3.map(y => ({
    Departement: row3.Département,
    Annee: +y,
    Volume: parseFloat(row3[y].replace(",", "."))
  }));
});

data_long3
```



```js
const maxVolume1 = Math.max(...data_long1.map(d => d.Volume));
const maxVolume2 = Math.max(...data_long2.map(d => d.Volume));

// Le vrai maximum entre les deux datasets
const maxVolume = Math.max(maxVolume1, maxVolume2);

```

```js
const maxVolume3 = Math.max(...data_long3.map(d => d.Volume));

```

```js
Plot.plot({
  width: 800,
  height: 400,
  x: {
    label: "Année",
    tickFormat: d => d.toString(), // texte pour l'axe X
  },
  y: {
    label: "Volume (en milliers de m3 ronds sur écorce)",
    domain: [0, maxVolume * 1.1]   // axe Y à partir de 0
  },
  color: {legend: true}, // légende pour différencier les départements
  marks: [
    // première courbe
    Plot.line(data_long1, {x: "Annee", y: "Volume", stroke: "Departement"}),
    Plot.dot(data_long1, {x: "Annee", y: "Volume", fill: "Departement",
                     title: d => `${d.Departement}\n${d.Annee}: ${d.Volume}`}),
    
    // deuxième courbe
    Plot.line(data_long2, {x: "Annee", y: "Volume", stroke: "Departement"}),
    Plot.dot(data_long2, {x: "Annee", y: "Volume", fill: "Departement",
                     title: d => `${d.Departement}\n${d.Annee}: ${d.Volume}`}),

    // troisième courbe
    Plot.line(data_long3, {x: "Annee", y: "Volume", stroke: "Departement"}),
    Plot.dot(data_long3, {x: "Annee", y: "Volume", fill: "Departement",
                     title: d => `${d.Departement}\n${d.Annee}: ${d.Volume}`})
  ]
})
```



```js
// Ceci est le graphique à modifier :


Plot.plot({
    x: {tickFormat: ""}, // no comma for years
    y: {axis: "left", label: "Volume des départements (en milliers de m3 ronds sur écorce)", data_long1}, // show sales in millions
    marks: [
      Plot.axisY(.ticks(), {color: "steelblue", anchor: "right", label: "Volume de la France métropolitaine (en milliers de m3 ronds sur écorce)", data_long1}),
      Plot.ruleY([0]),
      Plot.lineY(data_long2, {x: "Annee", y: "Volume", stroke: "Departement"}),
      Plot.lineY(data_long3, {x: "Annee", y: "Volume", stroke: "Departement"})
    ]
  })
```

