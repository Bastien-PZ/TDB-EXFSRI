---
sql:
  recolte_departements_historique: ./data/recolte_departements_historique.csv  
  recolte_regions_historique: ./data/recolte_regions_historique.csv
---

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Début du code pour la présentation de la page
------------------------------------------------------------------------------------------------------------------------ -->

<link rel="stylesheet" href="./style.css">

<div class="window_title"><h2> Récolte de bois nationale </h2></div>

<h3><br>Choix des paramètres : </h3>

```js
/*Affichage des listes de paramètres dynamiques*/ 
const choix_liste_essences = view(Inputs.select(noms_essences, { label: "Choisissez une essence :"}));
const choix_liste_annee = view(Inputs.select(annees, { label: "Choisissez une année :", value: annees.sort().reverse()[0]}));
```

---

<h3>Cartes de la récolte nationale de  "${choix_liste_essences}" en ${choix_liste_annee} : </h3>

<table style="border-collapse: collapse;">
  <tr>
    <td style="border: none; padding: 20px;">
      <div style="width: 500px; height: 550px; overflow: hidden; border: 0px solid #999999;">
        ${map_recolte_dep}
        <br><br>
        <i>Carte 1 : Récolte départementale de  "${choix_liste_essences}"</i>
        <i> en ${choix_liste_annee}. <br> Source : Enquête EXF-SRI</i>
      </div>
    </td>
    <td style="border: none; padding: 50px;">
    </td>
    <td style="border: none; padding: 20px;">
      <div style="width: 500px; height: 550px; overflow: hidden; border: 0px solid #999999;">
        ${map_recolte_reg}
        <br><br>
        <i>Carte 2 : Récolte régionale de  "${choix_liste_essences}" en ${choix_liste_annee}. <br>Source : Enquête EXF-SRI<i>
      </div>
    </td>
  </tr>
</table>

Ajustez la taille des bulles des cartes ci-dessus avec ce curseur :

```js
const k = view(Inputs.range([0, 100], {step: 1, label: "", value: 25}))
```
---

<h3>Cartes de l'évolution de la récolte nationale de  "${choix_liste_essences}" entre ${Math.min(choix_liste_annee, choix_liste_annee_compar)} et ${Math.max(choix_liste_annee, choix_liste_annee_compar)} : </h3>

```js
const choix_liste_annee_compar = view(Inputs.select(annees, { label: "Choisissez l'année de comparaison :", value: annees.sort().reverse()[1]}));
```

<table style="border-collapse: collapse;">
  <tr>
    <td style="border: none; padding: 20px;">
      <div style="width: 500px; height: 600px; overflow: hidden; border: 0px solid #999999;">
        ${map_recolte_dep_evol}
        <br><br>
        <i>Carte 3 : Evolution (en %) de la récolte départementale de  "${choix_liste_essences}" entre ${Math.min(choix_liste_annee, choix_liste_annee_compar)} et ${Math.max(choix_liste_annee, choix_liste_annee_compar)}.<br>
        En rouge les évolutions négatives, en vert les évolutions positives.<br> Source : Enquête EXF-SRI</i>
      </div>
    </td>
    <td style="border: none; padding: 50px;">
    </td>
    <td style="border: none; padding: 20px;">
      <div style="width: 500px; height: 600px; overflow: hidden; border: 0px solid #999999;">
        ${map_recolte_reg_evol}
        <br><br>
        <i>Carte 4 : Evolution (en %) de la récolte départementale de  "${choix_liste_essences}" entre ${Math.min(choix_liste_annee, choix_liste_annee_compar)} et ${Math.max(choix_liste_annee, choix_liste_annee_compar)}.<br>
        En rouge les évolutions négatives, en vert les évolutions positives.<br>Source : Enquête EXF-SRI</i>
      </div>
    </td>
  </tr>
</table>

Ajustez la taille des bulles des cartes ci-dessus avec ce curseur :

```js
const l = view(Inputs.range([0, 200], {step: 1, label: "", value: 70}))
```

---

<h3>Evolution historique de la récolte nationale de "${choix_liste_essences}" : </h3>

(Optionnel) Vous pouvez ajouter une région au graphique : 

```js
/*Affichage des listes de paramètres dynamiques*/ 
const choix_liste_regions = view(Inputs.select(noms_regions));
```

${graphique_evol_recolte_nationale_historique}

<div style="width: 5000px; height: 45px; overflow: hidden; border: 0px solid #999999;    font-size: 14px;margin-bottom: 0 ">
  <i>Graphique 5 : Evolution de la récolte nationale historique de  "${choix_liste_essences}". <br>Source : Enquête EXF-SRI</i>
</div>

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Fin du code pour la présentation de la page
------------------------------------------------------------------------------------------------------------------------ -->

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Début du code pour réaliser les graphiques
------------------------------------------------------------------------------------------------------------------------ -->

<!-- ------------------------------------------------
    Préparation de l'environnement et des données
------------------------------------------------- -->

```js
import { select, table } from "@observablehq/inputs";
import {createOptionsEChartsFromData} from "./components/graphHisto.js";
import * as Plot from "npm:@observablehq/plot";
import * as d3 from "npm:d3";
import * as topojson from "npm:topojson-client";
import * as bertin from "npm:bertin";
```

```js
const departements = FileAttachment("./data/departements.geojson").json()
const regions = FileAttachment("./data/regions.geojson").json()
```

```sql id=liste_departements
/*Requête SQL pour obtenir la liste des départements*/ 
SELECT DISTINCT Département as departements
FROM recolte_departements_historique
```

```sql id=liste_essences
/*Requête SQL pour obtenir la liste des essences*/ 
SELECT DISTINCT Récolte as essences 
FROM recolte_departements_historique
```

```sql id=borne_annees
/*Requête SQL pour obtenir la liste des années*/ 
SELECT 
  MIN(CAST(column_name AS INTEGER)) AS annee_min,
  MAX(CAST(column_name AS INTEGER)) AS annee_max
FROM (
  SELECT column_name
  FROM information_schema.columns
  WHERE table_name='recolte_departements_historique'
  AND column_name LIKE '____' -- 4 caractères
)
```

```js
/*Création de la liste des années à partir des bornes obtenues dans la requête*/ 
const { annee_min, annee_max } = borne_annees.toArray()[0];

const annees = Array.from(
  { length: annee_max - annee_min + 1 }, 
  (_, i) => (annee_min + i).toString()
);
```

```js
// Mise en forme
const tab_essences = liste_essences.toArray();
const noms_essences = tab_essences.map(d => d.essences);
```


<!-- -------------------------------------------
Chargement des données départementales csv
-------------------------------------------- -->

```js
// Données de récolte départementales
const fichier_recolte_dep_init = await FileAttachment("./data/recolte_departements_historique.csv").dsv({delimiter: ";", array: true})
const colonnes_fichier_recolte_dep_init = fichier_recolte_dep_init[0];
const lignes_fichier_recolte_dep_init = fichier_recolte_dep_init.slice(1);

const data_recolte_dep = lignes_fichier_recolte_dep_init.map(lignes_fichier_recolte_dep_init => {
  const obj = {};
  colonnes_fichier_recolte_dep_init.forEach((colonnes_fichier_recolte_dep_init, index) => {
    obj[colonnes_fichier_recolte_dep_init] = lignes_fichier_recolte_dep_init[index];
  });
  return obj;
});
```

```js
// Données de récolte régionales
const fichier_recolte_reg_init = await FileAttachment("./data/recolte_regions_historique.csv").dsv({delimiter: ";", array: true})
const colonnes_fichier_recolte_reg_init = fichier_recolte_reg_init[0];
const lignes_fichier_recolte_reg_init = fichier_recolte_reg_init.slice(1);

const data_recolte_reg = lignes_fichier_recolte_reg_init.map(lignes_fichier_recolte_reg_init => {
  const obj = {};
  colonnes_fichier_recolte_reg_init.forEach((colonnes_fichier_recolte_reg_init, index) => {
    obj[colonnes_fichier_recolte_reg_init] = lignes_fichier_recolte_reg_init[index];
  });
  return obj;
});
```

<!-- ------------------------------------------------------------------------------------------------------------------------------------>
<!-- ------------------------------------------------
    Carte de la récolte départementale
------------------------------------------------- -->

```js
// Filtrage de l'année et du département
const fin_dep = data_recolte_dep.map(lignes_fichier_recolte_dep_init => ({
    Département: lignes_fichier_recolte_dep_init["Département"],
    Récolte: lignes_fichier_recolte_dep_init["Récolte"],
    Valeur: lignes_fichier_recolte_dep_init[choix_liste_annee]
  }));

const test4_dep = fin_dep.filter(lignes_fichier_recolte_dep_init => lignes_fichier_recolte_dep_init.Récolte === choix_liste_essences);

const test4_dep_with_agg = test4_dep.map(item => ({
  ...item,
  Valeur: Number(item.Valeur.replace(",", "."))
}));
```

```js
const test4_dep_prepared = test4_dep_with_agg.map(d => ({
  code: d["Département"].split(" - ")[0],
  nom: d["Département"].split(" - ")[1],
  recolte: d["Récolte"],
  valeur: +d["Valeur"]
}));
```

```js
const datamap_dep = bertin.merge(departements, 'code', test4_dep_prepared, 'code')
```

```js
// Calcul des centroïdes pour les bulles
const centroids_dep = {
  type: "FeatureCollection",
  features: datamap_dep.features.map(f => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: d3.geoCentroid(f)
    },
    properties: f.properties
  }))
};
```

```js
const map_recolte_dep = bertin.draw({
  params: {
    background: "white",
    projection: "Mercator",
    width: width
  },
  layers: [
        {
      type: "bubble",
      geojson: centroids_dep,
      fill: "#767676",
      values: "valeur",
      k: k,
      fixmax: 1500,
      tooltip: d => `${d.properties.nom}: ${d.properties.valeur} m³ ronds sur écorce`,
      fillOpacity: 0.8,
      dorling: true 
    },
    {
      type: "layer",
      geojson: datamap_dep,
      fill: "#87d7f5",
      viewof: true 
    },
  ]
})

```

<!-- ------------------------------------------------------------------------------------------------------------------------------------>
<!-- ------------------------------------------------
    Carte de la récolte régionale
------------------------------------------------- -->

```js
// Filtrage de l'année et du département pour le treemap départemental
const fin_reg = data_recolte_reg.map(lignes_fichier_recolte_reg_init => ({
    Région: lignes_fichier_recolte_reg_init["Région"],
    Récolte: lignes_fichier_recolte_reg_init["Récolte"],
    Valeur: lignes_fichier_recolte_reg_init[choix_liste_annee]
  }));

const test4_reg = fin_reg.filter(lignes_fichier_recolte_reg_init => lignes_fichier_recolte_reg_init.Récolte === choix_liste_essences);

const test4_reg_with_agg = test4_reg.map(item => ({
  ...item,
  Valeur: Number(item.Valeur.replace(",", "."))
}));
```


```js
const test4_reg_prepared = test4_reg_with_agg.map(d => ({
  code: d["Région"].split(" - ")[0],
  nom: d["Région"].split(" - ")[1],
  recolte: d["Récolte"],
  valeur: +d["Valeur"]
}));
```

```js
const regions_filtree = {
  ...regions,
  features: regions.features.filter(f => !['01', '02', '03','04','06'].includes(f.properties.code))
}
```

```js
const datamap_reg = bertin.merge(regions_filtree, 'code', test4_reg_prepared, 'code')
```

```js
// Calcul des centroïdes pour les bulles
const centroids_reg = {
  type: "FeatureCollection",
  features: datamap_reg.features.map(f => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: d3.geoCentroid(f)
    },
    properties: f.properties
  }))
};
```

```js
const map_recolte_reg = bertin.draw({
  params: {
    background: "white",
    projection: "Mercator",
    width: width
  },
  layers: [
        {
      type: "bubble",
      geojson: centroids_reg,
      fill: "#767676",
      values: "valeur",
      k: k,
      fixmax: 1500,
      tooltip: d => `${d.properties.nom}: ${d.properties.valeur} m³ ronds sur écorce`,
      fillOpacity: 0.8,
      dorling: true 
    },
    {
      type: "layer",
      geojson: datamap_reg,
      fill: "#87d7f5",
      viewof: true 
    },
  ]
})

```

<!-- ------------------------------------------------------------------------------------------------------------------------------------>
<!-- ----------------------------------------------------
    Carte de l'évolution de la récolte départementale
----------------------------------------------------- -->

```js
// Filtrage de l'année et du département pour le treemap départemental
const fin_dep_evol = data_recolte_dep.map(lignes_fichier_recolte_dep_init => ({
    Département: lignes_fichier_recolte_dep_init["Département"],
    Récolte: lignes_fichier_recolte_dep_init["Récolte"],
    Valeur_min: lignes_fichier_recolte_dep_init[Math.min(choix_liste_annee, choix_liste_annee_compar)],
    Valeur_max: lignes_fichier_recolte_dep_init[Math.max(choix_liste_annee, choix_liste_annee_compar)]
  }));

const test4_dep_evol = fin_dep_evol.filter(lignes_fichier_recolte_dep_init => lignes_fichier_recolte_dep_init.Récolte === choix_liste_essences);

const test4_dep_with_agg_evol = test4_dep_evol.map(item => ({
  ...item,
  Valeur_min: Number(item.Valeur_min.replace(",", ".")),
  Valeur_max: Number(item.Valeur_max.replace(",", "."))
}));
```

```js
const test4_dep_prepared_evol = test4_dep_with_agg_evol.map(d => ({
  code: d["Département"].split(" - ")[0],
  nom: d["Département"].split(" - ")[1],
  recolte: d["Récolte"],
  valeur_min: +d["Valeur_min"],
  valeur_max: +d["Valeur_max"]
}));
```
```js
const test4_dep_prepared_evol_calc = test4_dep_prepared_evol.map(d => ({
  ...d,
  evolution_absolue: (d.valeur_max - d.valeur_min).toFixed(1),
  evolution_pourcent: (((d.valeur_max - d.valeur_min) / d.valeur_min) * 100).toFixed(1)
}));
```

```js
const datamap_dep_evol = bertin.merge(departements, 'code', test4_dep_prepared_evol_calc, 'code')
```

```js
// Calcul des centroïdes pour les bulles
const centroids_dep_evol = {
  type: "FeatureCollection",
  features: datamap_dep_evol.features.map(f => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: d3.geoCentroid(f)
    },
    properties: f.properties
  }))
};
```

```js
const map_recolte_dep_evol = bertin.draw({
  params: {
    background: "white",
    projection: "Mercator",
    width: width
  },
  layers: [
        {
      type: "bubble",
      geojson: centroids_dep_evol,
      fill: {
        type: "choro",
        values: "evolution_pourcent",
        colors: ["#d7191c", "#fdae61", "#ffffbf", "#a6d96a", "#1a9641"],
        breaks: [-10, -5, 0, 5, 10]
      },
      values: "evolution_absolue",
      k: l,
      fixmax: 1500,
      fillOpacity: 0.8,
      dorling: true 
    },
    {
      type: "layer",
      geojson: datamap_dep_evol,
      tooltip: d => `${d.properties.nom}: ${d.properties.evolution_pourcent} % (soit ${d.properties.evolution_absolue} milliers de m3)`,
      fill: "#87d7f5",
      viewof: true 
    },
  ]
})
```

<!-- ------------------------------------------------------------------------------------------------------------------------------------>
<!-- ----------------------------------------------------
    Carte de l'évolution de la récolte régionale
----------------------------------------------------- -->

```js
// Filtrage de l'année et du département pour le treemap départemental
const fin_reg_evol = data_recolte_reg.map(lignes_fichier_recolte_reg_init => ({
    Région: lignes_fichier_recolte_reg_init["Région"],
    Récolte: lignes_fichier_recolte_reg_init["Récolte"],
    Valeur_min: lignes_fichier_recolte_reg_init[Math.min(choix_liste_annee, choix_liste_annee_compar)],
    Valeur_max: lignes_fichier_recolte_reg_init[Math.max(choix_liste_annee, choix_liste_annee_compar)]
  }));

const test4_reg_evol = fin_reg_evol.filter(lignes_fichier_recolte_reg_init => lignes_fichier_recolte_reg_init.Récolte === choix_liste_essences);

const test4_reg_with_agg_evol = test4_reg_evol.map(item => ({
  ...item,
  Valeur_min: Number(item.Valeur_min.replace(",", ".")),
  Valeur_max: Number(item.Valeur_max.replace(",", "."))
}));
```

```js
const test4_reg_prepared_evol = test4_reg_with_agg_evol.map(d => ({
  code: d["Région"].split(" - ")[0],
  nom: d["Région"].split(" - ")[1],
  recolte: d["Récolte"],
  valeur_min: +d["Valeur_min"],
  valeur_max: +d["Valeur_max"]
}));
```
```js
const test4_reg_prepared_evol_calc = test4_reg_prepared_evol.map(d => ({
  ...d,
  evolution_absolue: (d.valeur_max - d.valeur_min).toFixed(1),
  evolution_pourcent: (((d.valeur_max - d.valeur_min) / d.valeur_min) * 100).toFixed(1)
}));
```

```js
const datamap_reg_evol = bertin.merge(regions_filtree, 'code', test4_reg_prepared_evol_calc, 'code')
```

```js
// Calcul des centroïdes pour les bulles
const centroids_reg_evol = {
  type: "FeatureCollection",
  features: datamap_reg_evol.features.map(f => ({
    type: "Feature",
    geometry: {
      type: "Point",
      coordinates: d3.geoCentroid(f)
    },
    properties: f.properties
  }))
};
```

```js
const map_recolte_reg_evol = bertin.draw({
  params: {
    background: "white",
    projection: "Mercator",
    width: width
  },
  layers: [
        {
      type: "bubble",
      geojson: centroids_reg_evol,
      fill: {
        type: "choro",
        values: "evolution_pourcent",
        colors: ["#d7191c", "#fdae61", "#ffffbf", "#a6d96a", "#1a9641"],
        breaks: [-10, -5, 0, 5, 10]
      },
      values: "evolution_absolue",
      k: l,
      fixmax: 1500,
      fillOpacity: 0.8,
      dorling: true 
    },
    {
      type: "layer",
      geojson: datamap_reg_evol,
      tooltip: d => `${d.properties.nom}: ${d.properties.evolution_pourcent} % (soit ${d.properties.evolution_absolue} milliers de m3)`,
      fill: "#87d7f5",
      viewof: true 
    },
  ]
})
```

<!-- ------------------------------------------------------------------------------------------------------------------------------------>
<!-- ----------------------------------------------------
    Graphique de l'évolution de la récolte nationale
----------------------------------------------------- -->

```sql id=liste_regions
/*Requête pour obtenir la liste des régions*/ 
SELECT DISTINCT Région as regions
FROM recolte_regions_historique
```

```js
/*Mise en forme*/ 
const tab_regions = liste_regions.toArray();
const noms_regions = tab_regions.map(d => d.regions);
```

```sql id=test1
SELECT * 
FROM recolte_regions_historique 
WHERE Région=${choix_liste_regions} 
AND Récolte=${choix_liste_essences}
```

```sql id=test3
SELECT * 
FROM recolte_regions_historique 
WHERE Région='France métropolitaine'
AND Récolte=${choix_liste_essences}
```

```js
const table_filtree1 = test1.toArray();
const table_filtree3 = test3.toArray();
```

```js
// On récupère la première ligne
const row1 = table_filtree1[0];
const row3 = table_filtree3[0];
```

```js
// On crée un tableau "long" {Departement, Annee, Volume}
const data_long1 = table_filtree1.flatMap(row1 => {
  const years1 = Object.keys(row1).filter(d => /^\d{4}$/.test(d));
  return years1.map(y => ({
    Region: row1.Région,
    Annee: +y,
    Volume: parseFloat(row1[y].replace(",", ".")),
    Recolte: row1.Récolte
  }));
});

const data_long3 = table_filtree3.flatMap(row3 => {
  const years3 = Object.keys(row3).filter(d => /^\d{4}$/.test(d));
  return years3.map(y => ({
    Region: row3.Région,
    Annee: +y,
    Volume: parseFloat(row3[y].replace(",", ".")),
    Recolte: row3.Récolte
  }));
});
```

```js
const maxVolume1 = Math.max(...data_long1.map(d => d.Volume));
const maxVolume3 = Math.max(...data_long3.map(d => d.Volume));
```

```js
const graphique_evol_recolte_nationale_historique = Plot.plot({
  width: 900,
  height: 400,
  x: {
    label: "Année",
    tickFormat: d => d.toString(), // texte pour l'axe X
  },
  y: {
    label: "Volume (en m3 ronds sur écorce)",
    domain: [0, maxVolume3 * 1.1]   // axe Y à partir de 0
  },
  color: {legend: true}, // légende pour différencier les départements
  marks: [
    // troisième courbe
    Plot.line(data_long3, {x: "Annee", y: "Volume", stroke: "Region"}),
    Plot.dot(data_long3, {x: "Annee", y: "Volume", fill: "Region",
                     title: d => `${d.Region}\n${d.Annee}: ${d.Volume.toFixed(0)} m3 ronds sur écorce de ${d.Recolte}`}),
    // première courbe
    Plot.line(data_long1, {x: "Annee", y: "Volume", stroke: "Region"}),
    Plot.dot(data_long1, {x: "Annee", y: "Volume", fill: "Region",
                     title: d => `${d.Region}\n${d.Annee}: ${d.Volume.toFixed(0)} m3 ronds sur écorce de ${d.Recolte}`})
  ]
})
```

<!-- ----------------------------------------------------------------------------------------------------------------------- 
                                     Fin du code pour réaliser les graphiques
------------------------------------------------------------------------------------------------------------------------ -->
