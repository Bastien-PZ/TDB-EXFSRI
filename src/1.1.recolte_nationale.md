---
title: Récolte de bois nationale
sql:
  recolte_departements_historique: ./data/recolte_departements_historique.csv
---

To do : Carte départementale de la récolte par année et essence
To do : Carte régionale de la récolte par année et essence
To do : Evolution de la récolte historique par essence (comme approche departementale)

```js
import { select, table } from "@observablehq/inputs";
import {createOptionsEChartsFromData} from "./components/graphHisto.js";
import * as Plot from "npm:@observablehq/plot";
import {d3} from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
import {topojson} from "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";
//import {geoMercator, geoPath, scaleSqrt} from "d3";
import * as bertin from "https://esm.run/bertin"
```

<h1> Récolte de bois nationale </h1>


```sql id=liste_departements
/*Requête pour obtenir la liste des départements*/ 
SELECT DISTINCT Département as departements
FROM recolte_departements_historique
```

```sql id=liste_essences
/*Requête pour obtenir la liste des essences*/ 
SELECT DISTINCT Récolte as essences 
FROM recolte_departements_historique
```

```sql id=borne_annees
/*Requête pour obtenir la liste des années*/ 
SELECT 
  MIN(CAST(column_name AS INTEGER)) AS annee_min,
  MAX(CAST(column_name AS INTEGER)) AS annee_max
FROM (
  SELECT column_name
  FROM information_schema.columns
  WHERE table_name='recolte_departements_historique'
  AND column_name LIKE '____' -- 4 caractères
)
```

```js
/*Création de la liste des années à partir des bornes obtenues dans la requête*/ 
const { annee_min, annee_max } = borne_annees.toArray()[0];
const annees = Array.from(
  { length: annee_max - annee_min + 1 }, 
  (_, i) => (annee_min + i).toString()
);
```

```js
/*Mise en forme*/ 
const tab_essences = liste_essences.toArray();
```

```js
/*Mise en forme*/ 
const noms_essences = tab_essences.map(d => d.essences);
```

```js
/*Affichage des listes de paramètres dynamiques*/ 
const choix_liste_essences = view(Inputs.select(noms_essences, { label: "Choisissez une essence :"}));
const choix_liste_annee = view(Inputs.select(annees, { label: "Choisissez une année :"}));
```

<!-- ------------------------------
Chargement des données csv
-------------------------------- -->

```js
const fichier_recolte_init = await FileAttachment("./data/recolte_departements_historique.csv").dsv({delimiter: ";", array: true})
const colonnes_fichier_recolte_init = fichier_recolte_init[0];
const lignes_fichier_recolte_init = fichier_recolte_init.slice(1);

const data_recolte = lignes_fichier_recolte_init.map(lignes_fichier_recolte_init => {
  const obj = {};
  colonnes_fichier_recolte_init.forEach((colonnes_fichier_recolte_init, index) => {
    obj[colonnes_fichier_recolte_init] = lignes_fichier_recolte_init[index];
  });
  return obj;
});
```

```js
// Filtrage de l'année et du département pour le treemap départemental
const fin = data_recolte.map(lignes_fichier_recolte_init => ({
    Département: lignes_fichier_recolte_init["Département"],
    Récolte: lignes_fichier_recolte_init["Récolte"],
    Valeur: lignes_fichier_recolte_init[choix_liste_annee]
  }));

const test4 = fin.filter(lignes_fichier_recolte_init => lignes_fichier_recolte_init.Récolte === choix_liste_essences);

const test4_with_agg = test4.map(item => ({
  ...item,
  Valeur: Number(item.Valeur.replace(",", "."))
}));
```

```js
const test4_prepared = test4_with_agg.map(d => ({
  code: d["Département"].split(" - ")[0],
  nom: d["Département"].split(" - ")[1],
  recolte: d["Récolte"],
  valeur: +d["Valeur"]
}));
```



```js
const departements = FileAttachment("./data/departements.geojson").json()
```

```js
const datamap = bertin.merge(departements, 'code', test4_prepared, 'code')
```

```js
datamap
```


```js
const map_recolte_dep = bertin.draw({
  params: {
    background: "#bde1f0",
    projection: "user",
    width: width
  },
  layers: [
    { type: "header", text: ' en millier de m3', fill: "#000000" },
    {
      type: "layer",
      geojson: datamap,
      fill: "#f5d482",
      tooltip: d => d.properties.nom,
      viewof: true 
    },
    {
      type: "bubble",
      geojson: datamap,
      fill: "#767676",
      values: "valeur",
      k: 30,
      fixmax: 1500,
      tooltip: d => `${d.properties.nom}: ${d.properties.valeur} milliers m³`,
      fillOpacity: 0.8,
      dorling: true  // Important : calcule automatiquement les centroïdes
    }
  ]
})

```

```js
map_recolte_dep
```






